<!doctype html><html lang=en><head><title>Running UniFi Video on a Synology NAS ::
Memory Leak — Rui Marinho</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="UPDATE 3 (2017-11-23) added instructions on migrating to custom SSL certificates sing v3.8.1+.
UPDATE 2 (2017-10-12): ctindel/unifi-video-controller:3.8.1 switches to the less permissive unifi-video user and attempts to chown the directory to that user during boot. Depending on your original mounted volume permissions, you may need an extra tweak on the host OS to ensure the script doesn&amp;rsquo;t fail:
❯ chown -R 107:109 /volume1/applications/unifi-video ❯ chmod -R 755 /volume1/applications/unifi-video UPDATE 1 (2017-10-10): ctindel/unifi-video-controller:3."><meta name=keywords content="blog technology automation devops network security"><meta name=robots content="noodp"><link rel=canonical href=https://memoryleak.dev/post/running-unifi-video-on-a-synology-nas/><link rel=stylesheet href=https://memoryleak.dev/assets/style.css><link rel=stylesheet href=https://memoryleak.dev/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://memoryleak.dev/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://memoryleak.dev/img/favicon.png><link href=https://memoryleak.dev/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://memoryleak.dev/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://memoryleak.dev/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://memoryleak.dev/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://memoryleak.dev/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://memoryleak.dev/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Running UniFi Video on a Synology NAS"><meta name=twitter:description content="UPDATE 3 (2017-11-23) added instructions on migrating to custom SSL certificates sing v3.8.1+.
UPDATE 2 (2017-10-12): ctindel/unifi-video-controller:3.8.1 switches to the less permissive unifi-video user and attempts to chown the directory to that user during boot. Depending on your original mounted volume permissions, you may need an extra tweak on the host OS to ensure the script doesn&rsquo;t fail:
❯ chown -R 107:109 /volume1/applications/unifi-video ❯ chmod -R 755 /volume1/applications/unifi-video UPDATE 1 (2017-10-10): ctindel/unifi-video-controller:3."><meta property="og:title" content="Running UniFi Video on a Synology NAS"><meta property="og:description" content="UPDATE 3 (2017-11-23) added instructions on migrating to custom SSL certificates sing v3.8.1+.
UPDATE 2 (2017-10-12): ctindel/unifi-video-controller:3.8.1 switches to the less permissive unifi-video user and attempts to chown the directory to that user during boot. Depending on your original mounted volume permissions, you may need an extra tweak on the host OS to ensure the script doesn&rsquo;t fail:
❯ chown -R 107:109 /volume1/applications/unifi-video ❯ chmod -R 755 /volume1/applications/unifi-video UPDATE 1 (2017-10-10): ctindel/unifi-video-controller:3."><meta property="og:type" content="article"><meta property="og:url" content="https://memoryleak.dev/post/running-unifi-video-on-a-synology-nas/"><meta property="article:published_time" content="2017-01-22T19:56:37+00:00"><meta property="article:modified_time" content="2017-11-23T21:31:17+00:00"><meta property="og:site_name" content="Memory Leak"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=https://memoryleak.dev/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>memory leak</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://memoryleak.dev/about/>About</a></li><li><a href=https://memoryleak.dev/>Blog</a></li><li><a href=https://github.com/ruimarinho>GitHub</a></li><li><a href=https://twitter.com/ruipmarinho>Twitter</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://memoryleak.dev/about/>About</a></li><li><a href=https://memoryleak.dev/>Blog</a></li><li><a href=https://github.com/ruimarinho>GitHub</a></li><li><a href=https://twitter.com/ruipmarinho>Twitter</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Running UniFi Video on a Synology NAS</h1><div class=post-meta><span class=post-date>2017-01-22</span></div><div class=post-content><p><em>UPDATE 3 (2017-11-23)</em> added instructions on migrating to custom SSL certificates sing v3.8.1+.</p><p><em>UPDATE 2 (2017-10-12): <code>ctindel/unifi-video-controller:3.8.1</code> <a href=https://github.com/ctindel/ubiquiti-docker/commit/e35419414e4d286d25d408e01c6458429809a9e9>switches</a> to the less permissive <code>unifi-video</code> user and attempts to chown the directory to that user during boot. Depending on your original mounted volume permissions, you may need an extra tweak on the host OS to ensure the script doesn&rsquo;t fail</em>:</p><pre><code>❯ chown -R 107:109 /volume1/applications/unifi-video
❯ chmod -R 755 /volume1/applications/unifi-video
</code></pre><p><em>UPDATE 1 (2017-10-10): <code>ctindel/unifi-video-controller:3.8.0</code> now uses port 7442 to securely manage cameras, therefore it has to be mapped.</em></p><hr><p>UniFi Video Cameras require a controller software called UniFi Video. It usually runs on a dedicated appliance (also sold by Ubiquiti) named <a href=https://www.ubnt.com/unifi-video/unifi-nvr/>NVR</a>. However, if you already have a NAS - more specifically, a Synology one - you can take advantage of it by running the UniFi Video software there without any issues. There&rsquo;s one caveat though&mldr; it requires Docker.</p><p>A lot of the newer Synology NAS devices support running <a href=https://www.synology.com/en-us/dsm/app_packages/Docker>Docker</a> (check the <em>Applied Models</em> footnote), which makes it very easy to run the UniFi Video software inside a container.</p><p>First, login via ssh and create a directory where you&rsquo;d like to store the controller data, including its database, metadata and videos:</p><pre><code>❯ mkdir -p /volume1/applications/unifi-video
</code></pre><p>If you haven&rsquo;t created a Docker network for running your containers, do so:</p><pre><code>docker network create -d bridge iot
</code></pre><p>Then run the container mapping the <a href=https://help.ubnt.com/hc/en-us/articles/217875218-UniFi-Video-Ports-Used>ports that make sense for your setup</a>:</p><pre><code>❯ docker run --restart always \
  --network iot \
  --name unifi-video \
  -h unifi-video \
  -p 6666:6666 \
  -p 7080:7080 \
  -p 7442:7442 \
  -p 7443:7443 \
  -p 7446:7446 \
  -p 7447:7447 \
  -v /volume1/applications/unifi-video:/var/lib/unifi-video \
  --cap-add=DAC_READ_SEARCH \
  --cap-add=NET_BIND_SERVICE \
  --cap-add=SETGID \
  --cap-add=SETUID \
  --cap-add=SYS_ADMIN \
  --cap-add=SYS_PTRACE \
  --security-opt apparmor:unconfined \
  -d ctindel/unifi-video-controller:3.9.0
</code></pre><p>Ports used in the current setup:</p><ul><li>6666/tcp: Inbound Camera Streams</li><li>7080/tcp: Web Interface over HTTPS</li><li>7442/tcp: Camera Management (as of v3.8.0+)</li><li>7443/tcp: Web Interface over HTTPS</li><li>7445/tcp: Video over HTTP (disable in my case)</li><li>7446/tcp: Video over HTTPS</li><li>7447/tcp: RTSP</li></ul><h2 id=unifi-video-nvr-settings>UniFi Video NVR Settings</h2><h3 id=configuring-the-camera-password>Configuring the camera password</h3><p>Whenever a camera is adopted by the UniFi Video software, it automatically provisions its settings, updates its firmware and changes its default password. To ensure that no one can simply browse to the camera&rsquo;s web interface and starts streaming its live feed, you should consider settings a good <code>Camera Password</code> (under UniFi Video <code>Settings</code>).</p><p><img src=https://memoryleak.dev/running-unifi-video-on-a-synology-nas/camera-password.png alt="Camera Password"></p><p>As soon as a camera is adopted by the UniFi Video software, it changes the default username/password to <code>ubnt/&lt;camera-password-from-unifi-video-settings></code>.</p><h3 id=enabling-time-based-purging>Enabling time based purging</h3><p>To avoid getting out of space quickly, the UniFi Video software should be configured to automatically purge recordings.</p><ul><li>Open the UniFi Video Web interface and go to <code>Settings</code></li><li>Click on the (dubious) <code>NVR Settings</code> button</li><li>Enable <code>Time Based Purging</code></li><li>Set <code>Time To Retain</code> (e.g. <code>2 weeks</code>)</li><li>Set <code>Space To Keep Free</code> (e.g. <code>1000GB</code>)</li><li>Clock <code>Save</code></li></ul><p><img src=https://memoryleak.dev/running-unifi-video-on-a-synology-nas/nvr-settings.png alt="NVR Settings"></p><h2 id=camera-adoption>Camera Adoption</h2><p>The default mode of Docker networking is <code>bridge</code>, which means each container creates a network stack on the default Docker bridge. This isolation is typically an obstacle when adopting UniFi cameras. The alternative is running the container with <code>--net=host</code> which uses the host&rsquo;s network stack, at the cost of no network isolation.</p><p>If you&rsquo;re running a home setup, then the workaround is simple and maintainable, allowing you to keep the default and more secure network isolation. First, attach the camera to your network and find its ip address on your router&rsquo;s network table. Let&rsquo;s imagine the ip of camera is 192.168.1.20 and that the Synology NAS has ip 192.168.1.8.</p><p>Browse to your camera&rsquo;s web configuration (https://192.168.1.30/) and enter the default username/password combination of <em>ubnt/ubnt</em>.</p><p>Point the NVR address on the camera to the Synology NAS server to 192.168.1.8 and hit save.</p><p>Now go back to the UniFi Video web interface, click on <code>Cameras</code> and for each one, click <code>Manage</code>.</p><h2 id=enabling-custom-ssl-certificate>Enabling custom SSL certificate</h2><p>If you already have a custom SSL certificate installed on your Synology NAS, you can configure UniFi Video to use it too.</p><p>On DSM 6+, by default the custom certificate is stored under <code>/usr/syno/etc/certificate/system/default</code>.</p><ul><li><code>/usr/syno/etc/certificate/system/default/cert.pem</code>: the certificate&rsquo;s public key</li><li><code>/usr/syno/etc/certificate/system/default/chain.pem</code>: generated by DSM and includes the intermediate CA + root CA</li><li><code>/usr/syno/etc/certificate/system/default/fullchain.pem</code>: generated by DSM and includes the certificate + the intermediate CA + root CA</li><li><code>/usr/syno/etc/certificate/system/default/privkey.pem</code>: the certificate&rsquo;s private key</li></ul><p>Originally, UniFi Video did not have support for custom certificates, so they had to be manually imported using a script that would write to the Java Keystore file. Since version 3.8.1, experimental support for adding custom certificates has been enabled by default. It also started using those certificates to encrypt traffic between the browser and the cameras.</p><p>If you have already imported custom certificates in the past, enter the running container before upgrading:</p><pre><code>docker exec -it unifi-video bash
</code></pre><p>And delete the following files:</p><pre><code>data/keystore
data/ufv-truststore
conf/evostream/server.*
</code></pre><p>If you are currently running a version higher than 3.8.0, you will need to do everything listed below plus un-managing all cameras.</p><p>Stop the running container and change the working dir to the UniFi video volume data dir. In my case, it&rsquo;s <code>/volume1/applications/unifi-video</code>.</p><p>Convert the private key to an RSA PKCS8 DER-encoded private key file:</p><pre><code>openssl pkcs8 -topk8 -inform PEM -outform DER -nocrypt -in /usr/syno/etc/certificate/system/default/privkey.pem -out certificates/ufv-server.key.der
</code></pre><p>Convert the certificate to an X509 DER-encoded certificate file:</p><pre><code>openssl x509 -in /usr/syno/etc/certificate/system/default/fullchain.pem -outform der -out certificates/ufv-server.cert.der
</code></pre><p>Make sure that the files are readable by the <code>unifi-video</code> user and group:</p><pre><code>chown -R 107:109 certificates/
</code></pre><p>Under <code>system.properties</code> add the following line:</p><pre><code>ufv.custom.certs.enable=true
</code></pre><p>Now start the container and the import process should be done automatically by UniFi Video. The files will be automatically removed once imported to the final keystore.</p><h2 id=updating-to-a-newer-build>Updating to a newer build</h2><p>Login via ssh and update the Docker image:</p><pre><code>docker pull ctindel/unifi-video-controller
</code></pre><p>Remove the old container:</p><pre><code>docker rm -f unifi-video
</code></pre><p>Re-run the same command that created the container in the first place.</p></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"memoryleak-ruimarinho"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user">Rui Marinho</div></div></footer><script src=https://memoryleak.dev/assets/main.js></script><script src=https://memoryleak.dev/assets/prism.js></script></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-90727541-1','auto');ga('send','pageview');}</script></body></html>