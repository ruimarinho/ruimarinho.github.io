<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.69.0"><title>Quick start guide to flashing ESP8266-based devices with PlatformIO - Rui Marinho</title><meta property="og:title" content="Quick start guide to flashing ESP8266-based devices with PlatformIO - Rui Marinho"><link rel=icon href=https://ruimarinho.github.io/images/ type=image/x-icon><link rel=stylesheet href=https://ruimarinho.github.io/css/main.css media=all><link rel=stylesheet href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700"><link rel=stylesheet href=https://ruimarinho.github.io/css/pre.css media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=https://ruimarinho.github.io/ class=nav-logo><img src=https://ruimarinho.github.io/images/profile.jpg width=50 height=50 alt="Rui's Profile Picture"></a><ul class=nav-links><li><a href=https://ruimarinho.github.io/about/>about</a></li><li><a href=https://github.com/ruimarinho>github</a></li><li><a href=https://ruimarinho.github.io/>posts</a></li><li><a href=https://twitter.com/ruipmarinho>twitter</a></li></ul></nav></header><main class=content role=main><article class=article><span class=article-duration>3 min read</span><h1 class=article-title>Quick start guide to flashing ESP8266-based devices with PlatformIO</h1><span class=article-date>January 13, 2018</span><div class=article-content><p>If you&rsquo;re into IoT, you&rsquo;ve probably heard of <a href=http://platformio.org/get-started>PlatformIO</a> - an integrated development environment for IoT similar to the Arduino IDE.</p><p>A lot of the IoT devices run on the low-cost ESP8266 chip. It can be found on a range of applications, from power meters to switches, sensors and even LED controllers. They are very popular in the DIY community but also commercially available in the form of ready-to-use products and development kits from several manufacturers, such as <a href=https://www.itead.cc>IteadStudio</a>, makers of the Sonoff product line, <a href=https://www.wemos.cc>Wemos</a>, known for its D1 Mini and <a href="https://www.aliexpress.com/item/16Million-colors-Wifi-RGB-RGBW-led-controller-smartphone-control-music-and-timer-mode-magic-home-wifi/32755262961.html?aff_platform=product&cpt=1514663542338&sk=VNnYVjE&aff_trace_key=28ac08e8485f4982bf4c3f386a3361b8-1514663542338-08826-VNnYVjE&terminal_id=c4865e9dca1640d9882c807e0632af1b">MagicHome LED Controllers</a>, to name a few.</p><p>The original firmware that these devices come with, besides being proprietary, hasn&rsquo;t been satisfactory for most IoT tinkerers. They lack support for other sensors and also miss controls and features one would like when connecting them too home automation systems, such as support for MQTT, REST APIs, Over-The-Air (OTA) updates and so much more.</p><p>Three widely popular open-source ESP8266 firmware alternatives with a focus on Sonoff products (but not exclusive to) are <a href=https://bitbucket.org/xoseperez/espurna/overview>ESPurna</a>, <a href=https://github.com/arendst/Sonoff-Tasmota>Sonoff-Tasmota</a> and <a href=https://github.com/letscontrolit/ESPEasy>ESPeasy</a>. Besides using PlatformIO, they all have in common a passionate community which dedicate a lot of their time adding support for new sensors and features. Their documentation is also really good.</p><p>If you would like to try any of these firmwares, you will need to flash your device using a USB-to-UART programmer. You can get acquainted about which pins to connect to by reading <a href=https://bitbucket.org/xoseperez/espurna/wiki/Hardware>ESPurna&rsquo;s Wiki</a>.</p><p>After connecting your device, install <code>platformio</code> using Homebrew:</p><pre><code>❯ brew install platformio
</code></pre><p>Clone the ESPurna repo and checkout the most recent tag:</p><pre><code>❯ git clone https://bitbucket.org/xoseperez/espurna.git
❯ git checkout $(git describe --tags)
❯ cd code
</code></pre><p>ESPurna comes with preconfigured device environments as listed under <code>platformio.ini</code>. It also offers some variants such as <code>dht</code> which bundle support for specific sensors (in this case, temperature and humidity).</p><p>For the first firmware flash, the regular variant should be used. Take the case of a Sonoff Basic.</p><p>Connect your device to your computer, put it in flash mode and run the <code>pio</code> command. It will download all dependencies, compile them, automatically detect the USB-to-UART programmer and upload the binary image to the device.</p><pre><code>❯ pio run -t upload -e itead-sonoff-basic
</code></pre><p>The procedure is very simple and takes about a minute to complete.</p><h3 id=over-the-air-ota-updates>Over-The-Air (OTA) Updates</h3><p>Most of these firmwares offer some kind of OTA update. Some <a href=https://www.letscontrolit.com/wiki/index.php/ESP_Easy_web_interface#Tools_Firmware_update_using_OTA>require uploading a binary image directly through their HTTP interface</a> while others <a href=https://github.com/arendst/Sonoff-Tasmota/wiki/Upgrade>bundle built-in functionality for remote downloading firmware images</a> which is pretty cool for automating updates.</p><p>ESPurna does it a little bit different by offering a special OTA environment for each device. For instance, if you would like to update your Sonoff Basic after flashing ESPurna once, then you could just do:</p><pre><code>❯ pio run -t upload -e itead-sonoff-basic-ota
</code></pre><p>This, of course, assumes that you left all configurations values to their defaults - that is IP and authentication password. Since hopefully that isn&rsquo;t the case, then there is a generic OTA environment which reads environment variables from your shell. This way you can dynamically configure your device information without having to change values directly on the <code>platformio.ini</code> file.</p><p>Export the shell variables:</p><pre><code>❯ export ESPURNA_BOARD=&quot;ITEAD_SONOFF_BASIC&quot;
❯ export ESPURNA_IP=&quot;192.168.10.1&quot;
❯ export ESPURNA_AUTH=&quot;foobar&quot;
</code></pre><p>Then run <code>pio</code> using the generic environment:</p><pre><code>❯ pio run -t upload -e esp8266-1m-ota
</code></pre><p>On a last note, if you&rsquo;re not into flashing through serial mode (required for the first flash), there is a new and exciting project that attempts to flash the Tasmota firmware using the original OTA mechanism of the Sonoff via WiFi - <a href=https://github.com/mirko/SonOTA>SonOTA</a>. Something to explore in the future!</p></div></article></main><footer class=footer><ul class=footer-links><li><a href=https://ruimarinho.github.io/index.xml type=application/rss+xml target=_blank>RSS feed</a></li></ul></footer></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-90727541-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>