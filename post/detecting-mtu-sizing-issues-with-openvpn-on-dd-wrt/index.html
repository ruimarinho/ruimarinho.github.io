<!doctype html><html lang=en><head><title>Detecting MTU sizing issues with OpenVPN on DD-WRT ::
Memory Leak â€” Rui Marinho</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Choosing the right DD-WRT firmware version for a router has never been an easy task. After the much anticipated v24 stable release got out (v24 SP1, around 9 years ago), the community continued to push for new features, support for different models and improved performance. But when all you had were 54Mbps (802.11g), wireless tuning was crucial. If any build got out with the promise of increased wireless speeds, everyone would upgrade immediately."><meta name=keywords content="blog technology automation devops network security"><meta name=robots content="noodp"><link rel=canonical href=https://memoryleak.dev/post/detecting-mtu-sizing-issues-with-openvpn-on-dd-wrt/><link rel=stylesheet href=https://memoryleak.dev/assets/style.css><link rel=stylesheet href=https://memoryleak.dev/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://memoryleak.dev/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://memoryleak.dev/img/favicon.png><link href=https://memoryleak.dev/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://memoryleak.dev/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://memoryleak.dev/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://memoryleak.dev/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://memoryleak.dev/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://memoryleak.dev/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Detecting MTU sizing issues with OpenVPN on DD-WRT"><meta name=twitter:description content="Choosing the right DD-WRT firmware version for a router has never been an easy task. After the much anticipated v24 stable release got out (v24 SP1, around 9 years ago), the community continued to push for new features, support for different models and improved performance. But when all you had were 54Mbps (802.11g), wireless tuning was crucial. If any build got out with the promise of increased wireless speeds, everyone would upgrade immediately."><meta property="og:title" content="Detecting MTU sizing issues with OpenVPN on DD-WRT"><meta property="og:description" content="Choosing the right DD-WRT firmware version for a router has never been an easy task. After the much anticipated v24 stable release got out (v24 SP1, around 9 years ago), the community continued to push for new features, support for different models and improved performance. But when all you had were 54Mbps (802.11g), wireless tuning was crucial. If any build got out with the promise of increased wireless speeds, everyone would upgrade immediately."><meta property="og:type" content="article"><meta property="og:url" content="https://memoryleak.dev/post/detecting-mtu-sizing-issues-with-openvpn-on-dd-wrt/"><meta property="article:published_time" content="2017-12-31T19:27:37+00:00"><meta property="article:modified_time" content="2017-12-31T19:27:37+00:00"><meta property="og:site_name" content="Memory Leak"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=https://memoryleak.dev/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>memory leak</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://memoryleak.dev/about/>About</a></li><li><a href=https://memoryleak.dev/>Blog</a></li><li><a href=https://github.com/ruimarinho>GitHub</a></li><li><a href=https://twitter.com/ruipmarinho>Twitter</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://memoryleak.dev/about/>About</a></li><li><a href=https://memoryleak.dev/>Blog</a></li><li><a href=https://github.com/ruimarinho>GitHub</a></li><li><a href=https://twitter.com/ruipmarinho>Twitter</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Detecting MTU sizing issues with OpenVPN on DD-WRT</h1><div class=post-meta><span class=post-date>2017-12-31</span></div><div class=post-content><p>Choosing the right DD-WRT firmware version for a router has never been an easy task. After the much anticipated v24 stable release got out (v24 SP1, around 9 years ago), the community continued to push for new features, support for different models and improved performance. But when all you had were 54Mbps (802.11g), wireless tuning was crucial. If any build got out with the promise of increased wireless speeds, everyone would upgrade immediately. New beta builds started popping up more frequently but the chance of picking up a random one that would brick your device was quite high. The community was testing builds fresh out of the development trunk and so months (or years?) later and after numerous requests, the <a href=https://www.dd-wrt.com/site/support/router-database>Recommended Router Database</a> was born to help guide users for the best firmware for their router.</p><p>The DD-WRT firmware became so popular that vendors like <a href=https://www.linksys.com/us/pressreleases/linksys-and-dd-wrt-announce-support-for-the-latest-wrt-routers/>Linksys</a> and <a href=http://www.buffalotech.com/products/airstation-highpower-n300-open-source-dd-wrt-wireless-router>Buffalo</a> created partnerships to launch products <em>tailored for DD-WRT</em>. While flashing and general support got much better with time, getting wireless radios to work properly didn&rsquo;t. Eventually the <em>Recommended Router Database</em> stopped being updated and the official wiki suffered the same fate. Unless you had time to scour through hundreds of forum posts, experimentation was your only hope. But others felt the same pain and started documenting their results. Steve Jenkins did so for his <a href=http://stevejenkins.com/blog/2013/01/my-cisco-linksys-e4200-dd-wrt-settings-for-max-speed/>Cisco E4200</a>, a router that I continue to own and operate for fun projects and experiments.</p><p>It has been a while since I last updated a DD-WRT based router. I&rsquo;ve moved all my gear to <a href=https://unifi-sdn.ubnt.com>Ubiquiti UniFi</a> and I couldn&rsquo;t be more satisfied with it, but I still rely on an old Netgear WNDRv3700 for a site-to-site VPN between my house and my parents'. This is great for backups and sharing resources, like printers or media storage. The radios had been very stable and I remember it took me a while to get the right settings for that to happen, but I decided to give it a try after the KRACK vulnerability was published and see where it would take me.</p><p>To avoid issues with older configurations values, I did a reset to factory defaults. By trial and error, last year I was forced to stop on <a href=http://ftp.dd-wrt.com/dd-wrtv2/downloads/betas/2016/11-14-2016-r30880/netgear-wndr3700/>11-14-2016-r30880</a> as OpenVPN got upgraded to the 2.4.x branch and after that revision it stopped working correctly due to the the lack of support by the OS for <code>--mtu-disc</code>. I&rsquo;ve since learned that <a href=https://community.openvpn.net/openvpn/ticket/909>defining the socket option</a> could have probably helped me workaround the issue.</p><p>This time I&rsquo;ve flashed build <a href=http://ftp.dd-wrt.com/dd-wrtv2/downloads/betas/2017/11-16-2017-r33772/netgear-wndr3700/>11-16-2017-r33772</a>. I was very happy to see it boot! OpenVPN was remarkably up-to-date (2.4.4), the latest at the time of writing, up from 2.3.5 with r30880, and apparently a connection was being established correctly to the OpenVPN server - I was impressed. But not for long&mldr;</p><p>The VPN connection was very slow and would freeze constantly. The WNDRv3700 router is a capable device, but I can max out its CPU (at 99.9% usage) if a lot of VPN bandwidth is consumed. In this case, regular browsing over VPN shared services would trigger the same behavior. I wondered what could be causing this.</p><p>After a lot of digging and configuration changes back and forth, I started suspecting that the MTU (the Maximum Transmission Unit) was incorrectly set. The basic rule is that the longer the MTU, the better for performance, but the worse for reliability. Could this be it?</p><p>I turned to the ping command on macOS to test if I was able to reach a host behind the VPN using a standard MTU of approximately 1500 bytes. If you consider an overhead of 18 bytes (header and trailer), you should be able to send an un-fragmented message 1450-1480 bytes long. To test that, I turned to the <code>ping</code> command. It can be configured to send one message (<code>-c 1</code>) with a size of 1470 bytes (<code>-s 1470</code>) and with the <em>Don&rsquo;t Fragment</em> bit set so that routers in between don&rsquo;t attempt to fragment it.</p><p>To my surprise, when I tried the following command, it failed:</p><pre><code>ping -D -v -s 1470 -c 1 192.168.1.8
ping: sendto: Message too long
</code></pre><p>That was unexpected! Even by lowering the message size to 1450 bytes, it still didn&rsquo;t work, so I tried lowering it in bigger increments. To my surprise, the maximum size I was able to send was 290 bytes - almost 5x less than a healthy connection was supposed to achieve.</p><p>While I haven&rsquo;t been able to find out the root cause of the MTU sizing issue - forcing me to revert to r30880 in the meantime - I got closer to it.</p></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"memoryleak-ruimarinho"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user">Rui Marinho</div></div></footer><script src=https://memoryleak.dev/assets/main.js></script><script src=https://memoryleak.dev/assets/prism.js></script></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-90727541-1','auto');ga('send','pageview');}</script></body></html>