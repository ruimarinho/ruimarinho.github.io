<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.69.0"><title>Detecting MTU sizing issues with OpenVPN on DD-WRT - Rui Marinho</title><meta property="og:title" content="Detecting MTU sizing issues with OpenVPN on DD-WRT - Rui Marinho"><link rel=icon href=https://ruimarinho.github.io/images/ type=image/x-icon><link rel=stylesheet href=https://ruimarinho.github.io/css/main.css media=all><link rel=stylesheet href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700"><link rel=stylesheet href=https://ruimarinho.github.io/css/pre.css media=all></head><body><div class=wrapper><header class=header><nav class=nav><a href=https://ruimarinho.github.io/ class=nav-logo><img src=https://ruimarinho.github.io/images/profile.jpg width=50 height=50 alt="Rui's Profile Picture"></a><ul class=nav-links><li><a href=https://ruimarinho.github.io/about/>about</a></li><li><a href=https://github.com/ruimarinho>github</a></li><li><a href=https://ruimarinho.github.io/>posts</a></li><li><a href=https://twitter.com/ruipmarinho>twitter</a></li></ul></nav></header><main class=content role=main><article class=article><span class=article-duration>4 min read</span><h1 class=article-title>Detecting MTU sizing issues with OpenVPN on DD-WRT</h1><span class=article-date>December 31, 2017</span><div class=article-content><p>Choosing the right DD-WRT firmware version for a router has never been an easy task. After the much anticipated v24 stable release got out (v24 SP1, around 9 years ago), the community continued to push for new features, support for different models and improved performance. But when all you had were 54Mbps (802.11g), wireless tuning was crucial. If any build got out with the promise of increased wireless speeds, everyone would upgrade immediately. New beta builds started popping up more frequently but the chance of picking up a random one that would brick your device was quite high. The community was testing builds fresh out of the development trunk and so months (or years?) later and after numerous requests, the <a href=https://www.dd-wrt.com/site/support/router-database>Recommended Router Database</a> was born to help guide users for the best firmware for their router.</p><p>The DD-WRT firmware became so popular that vendors like <a href=https://www.linksys.com/us/pressreleases/linksys-and-dd-wrt-announce-support-for-the-latest-wrt-routers/>Linksys</a> and <a href=http://www.buffalotech.com/products/airstation-highpower-n300-open-source-dd-wrt-wireless-router>Buffalo</a> created partnerships to launch products <em>tailored for DD-WRT</em>. While flashing and general support got much better with time, getting wireless radios to work properly didn&rsquo;t. Eventually the <em>Recommended Router Database</em> stopped being updated and the official wiki suffered the same fate. Unless you had time to scour through hundreds of forum posts, experimentation was your only hope. But others felt the same pain and started documenting their results. Steve Jenkins did so for his <a href=http://stevejenkins.com/blog/2013/01/my-cisco-linksys-e4200-dd-wrt-settings-for-max-speed/>Cisco E4200</a>, a router that I continue to own and operate for fun projects and experiments.</p><p>It has been a while since I last updated a DD-WRT based router. I&rsquo;ve moved all my gear to <a href=https://unifi-sdn.ubnt.com>Ubiquiti UniFi</a> and I couldn&rsquo;t be more satisfied with it, but I still rely on an old Netgear WNDRv3700 for a site-to-site VPN between my house and my parents&rsquo;. This is great for backups and sharing resources, like printers or media storage. The radios had been very stable and I remember it took me a while to get the right settings for that to happen, but I decided to give it a try after the KRACK vulnerability was published and see where it would take me.</p><p>To avoid issues with older configurations values, I did a reset to factory defaults. By trial and error, last year I was forced to stop on <a href=http://ftp.dd-wrt.com/dd-wrtv2/downloads/betas/2016/11-14-2016-r30880/netgear-wndr3700/>11-14-2016-r30880</a> as OpenVPN got upgraded to the 2.4.x branch and after that revision it stopped working correctly due to the the lack of support by the OS for <code>--mtu-disc</code>. I&rsquo;ve since learned that <a href=https://community.openvpn.net/openvpn/ticket/909>defining the socket option</a> could have probably helped me workaround the issue.</p><p>This time I&rsquo;ve flashed build <a href=http://ftp.dd-wrt.com/dd-wrtv2/downloads/betas/2017/11-16-2017-r33772/netgear-wndr3700/>11-16-2017-r33772</a>. I was very happy to see it boot! OpenVPN was remarkably up-to-date (2.4.4), the latest at the time of writing, up from 2.3.5 with r30880, and apparently a connection was being established correctly to the OpenVPN server - I was impressed. But not for long&mldr;</p><p>The VPN connection was very slow and would freeze constantly. The WNDRv3700 router is a capable device, but I can max out its CPU (at 99.9% usage) if a lot of VPN bandwidth is consumed. In this case, regular browsing over VPN shared services would trigger the same behavior. I wondered what could be causing this.</p><p>After a lot of digging and configuration changes back and forth, I started suspecting that the MTU (the Maximum Transmission Unit) was incorrectly set. The basic rule is that the longer the MTU, the better for performance, but the worse for reliability. Could this be it?</p><p>I turned to the ping command on macOS to test if I was able to reach a host behind the VPN using a standard MTU of approximately 1500 bytes. If you consider an overhead of 18 bytes (header and trailer), you should be able to send an un-fragmented message 1450-1480 bytes long. To test that, I turned to the <code>ping</code> command. It can be configured to send one message (<code>-c 1</code>) with a size of 1470 bytes (<code>-s 1470</code>) and with the <em>Don&rsquo;t Fragment</em> bit set so that routers in between don&rsquo;t attempt to fragment it.</p><p>To my surprise, when I tried the following command, it failed:</p><pre><code>ping -D -v -s 1470 -c 1 192.168.1.8
ping: sendto: Message too long
</code></pre><p>That was unexpected! Even by lowering the message size to 1450 bytes, it still didn&rsquo;t work, so I tried lowering it in bigger increments. To my surprise, the maximum size I was able to send was 290 bytes - almost 5x less than a healthy connection was supposed to achieve.</p><p>While I haven&rsquo;t been able to find out the root cause of the MTU sizing issue - forcing me to revert to r30880 in the meantime - I got closer to it.</p></div></article></main><footer class=footer><ul class=footer-links><li><a href=https://ruimarinho.github.io/index.xml type=application/rss+xml target=_blank>RSS feed</a></li></ul></footer></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-90727541-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>